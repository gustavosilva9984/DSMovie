<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    
    <!-- CSS do Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.css">
    
    <!-- Biblioteca Toastify -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- CSS Personalizado -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Manifesto da Aplicação -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Biblioteca jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Expor jsPDF globalmente
        window.jsPDF = window.jspdf.jsPDF;
    </script>
</head>
<body>
    <header>
        <img src="./Group 1.svg" alt="logo" class="logo">
    </header>

    <div class="filters" id="filters">
        <button class="print-button" onclick="window.print()">Baixar Catálogo</button>
        <button id="generate-pdf">Gerar PDF</button>
        <button id="show-all">Todos</button>
        <select id="category-select">
            <option value="">Escolha uma categoria</option>
        </select>
        <select id="subcategory-select" style="display: none;">
            <option value="">Escolha uma subcategoria</option>
        </select>
    </div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Pesquisar produto ou Código">
    </div>

    <div class="catalog-container" id="catalog-container">
        <!-- Os cards de produtos serão gerados dinamicamente aqui -->
    </div>

    <div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index: 1000;">
        <img id="modal-image" style="max-width:90%; max-height:90%;">
    </div>
      
     
    <script>
        const sheetId = '1mJbjNBsfJQmhThpFvaYchuvNslHtRBPWiV7fgzONJl8';
        const apiKey = 'AIzaSyBUBfQAzykuAOrdQzJHR_RTVzK0R5HhFrM';
        const sheetName1 = 'Pagina1'; // Primeira página com nome, código, etc.

        // URL para buscar dados da planilha
        const url1 = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName1}!A:Z?key=${apiKey}`;

        // Função para verificar se a resposta da API contém dados válidos
        function validateSheetData(data, sheetName) {
            if (!data || !data.values || data.values.length === 0) {
                throw new Error(`Nenhum dado encontrado na folha "${sheetName}". Verifique o nome da folha e o intervalo.`);
            }
        }

        // Função para truncar o texto se exceder o comprimento máximo
        function truncateText(text, maxLength) {
            if (text.length > maxLength) {
                return text.substring(0, maxLength) + '...';
            }
            return text;
        }

        // Requisição da folha usando fetch
        fetch(url1)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição para a folha ${sheetName1}: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data1 => {
                // Validar os dados recebidos
                validateSheetData(data1, sheetName1);

                const headers1 = data1.values[0];
                const products1 = data1.values.slice(1);

                const headerIndex1 = {
                    nome: headers1.indexOf('nome'),
                    codigo: headers1.indexOf('codigo'),
                    img: headers1.indexOf('img'),
                    categoria: headers1.indexOf('categoria'),
                    subcategoria: headers1.indexOf('subcategoria')
                };

                // Verificar se todas as colunas necessárias estão presentes
                if (Object.values(headerIndex1).includes(-1)) {
                    throw new Error('Uma ou mais colunas necessárias não foram encontradas na folha Pagina1.');
                }

                const catalogContainer = document.getElementById('catalog-container');
                const categorySelect = document.getElementById('category-select');
                const subcategorySelect = document.getElementById('subcategory-select');

                const categories = new Set();
                const subcategories = new Map();

                products1.forEach(product => {
                    const category = product[headerIndex1.categoria];
                    const subcategory = product[headerIndex1.subcategoria];

                    categories.add(category);
                    if (category && subcategory) {
                        if (!subcategories.has(category)) {
                            subcategories.set(category, new Set());
                        }
                        subcategories.get(category).add(subcategory);
                    }
                });

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

                // Adicionar a opção "Todas as subcategorias"
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'Todas as subcategorias';
                subcategorySelect.appendChild(allOption);

                function updateSubcategories() {
                    const selectedCategory = categorySelect.value;
                    subcategorySelect.innerHTML = '<option value="">Escolha uma subcategoria</option>';

                    if (selectedCategory) {
                        const subcategoriesForCategory = subcategories.get(selectedCategory);
                        if (subcategoriesForCategory) {
                            subcategoriesForCategory.forEach(subcategory => {
                                const option = document.createElement('option');
                                option.value = subcategory;
                                option.textContent = subcategory;
                                subcategorySelect.appendChild(option);
                            });
                        }
                        subcategorySelect.style.display = 'block';
                    } else {
                        subcategorySelect.style.display = 'none';
                    }
                }

                function displayProducts(productsToDisplay) {
                    catalogContainer.innerHTML = '';
                    productsToDisplay.forEach(product => {
                        const nome = product[headerIndex1.nome];
                        const codigo = product[headerIndex1.codigo];
                        const img = product[headerIndex1.img];

                        const card = document.createElement('div');
                        card.className = 'card';

                        card.innerHTML = `
                            <img src="${img}" alt="${nome}">
                            <div class="card-content">
                                <h3>${nome}</h3>
                                <p class="product-code">Código: ${codigo}</p>
                            </div>
                        `;

                        catalogContainer.appendChild(card);

                        // Evento para exibir imagem em modal
                        card.querySelector('img').addEventListener('click', () => {
                            document.getElementById('modal-image').src = img;
                            document.getElementById('image-modal').style.display = 'flex';
                        });

                        // Evento para fechar o modal
                        document.getElementById('image-modal').addEventListener('click', () => {
                            document.getElementById('image-modal').style.display = 'none';
                        });
                    });
                }

                // Função para gerar o PDF com produtos sem imagem
                document.getElementById('generate-pdf').addEventListener('click', () => {
                const productsWithoutImage = products1.filter(product => !product[headerIndex1.img] || product[headerIndex1.img].trim() === "");
                
                // Para depuração, imprime os produtos filtrados
                console.log("Produtos sem imagem:", productsWithoutImage);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(10); // Define o tamanho da fonte para 10
                doc.text('Produtos sem imagem', 10, 10);
                let y = 20; // Posição inicial no eixo Y

                // Verifica se há produtos sem imagem
                if (productsWithoutImage.length === 0) {
                    doc.text("Nenhum produto sem imagem encontrado.", 10, y);
                } else {
                    productsWithoutImage.forEach((product, index) => {
                        const nome = product[headerIndex1.nome];
                        const codigo = product[headerIndex1.codigo];
                        doc.text(`Nome: ${nome}, Código: ${codigo}`, 10, y);
                        y += 10; // Incrementa a posição Y para a próxima linha

                        // Desenhar uma linha separadora
                        doc.line(10, y, 200, y); // Linha horizontal
                        y += 5; // Espaço entre a linha e o próximo produto

                        // Verifica se a posição Y excede o limite da página
                        if (y > 280) { // 280 é um valor aproximado para o limite da página
                            doc.addPage(); // Adiciona uma nova página
                            y = 10; // Reseta a posição Y para o topo da nova página
                        }
                    });
                }

                doc.save('produtos_sem_imagem.pdf');
            });


                // Ao carregar a página, exibir apenas os produtos da categoria "NOVIDADES"
                const noveltiesProducts = products1.filter(product => product[headerIndex1.categoria] === 'NOVIDADES');
                displayProducts(noveltiesProducts);

                function filterProducts() {
                    const selectedCategory = categorySelect.value;
                    const selectedSubcategory = subcategorySelect.value;

                    const filteredProducts = products1.filter(product => {
                        const productCategory = product[headerIndex1.categoria];
                        const productSubcategory = product[headerIndex1.subcategoria];
                        return (selectedCategory === '' || productCategory === selectedCategory) &&
                               (selectedSubcategory === '' || productSubcategory === selectedSubcategory);
                    });

                    displayProducts(filteredProducts);
                }

                const searchInput = document.getElementById('search-input');

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();

                    if (searchTerm === '') {
                        catalogContainer.innerHTML = '';
                        const filteredProducts = products1.filter(product => product[headerIndex1.categoria] === 'NOVIDADES');
                        displayProducts(filteredProducts);
                    } else {
                        const filteredProducts = products1.filter(product => {
                            const productName = product[headerIndex1.nome].toLowerCase();
                            const productCode = product[headerIndex1.codigo].toLowerCase();
                            return productName.includes(searchTerm) || productCode.includes(searchTerm);
                        });
                        displayProducts(filteredProducts);
                    }
                });

                categorySelect.addEventListener('change', () => {
                    updateSubcategories();
                    if (categorySelect.value) {
                        filterProducts();
                    } else {
                        catalogContainer.innerHTML = ''; // Limpa os produtos se nenhuma categoria for selecionada
                    }
                });

                subcategorySelect.addEventListener('change', filterProducts);
            })
            .catch(error => {
                console.error('Erro ao buscar dados da planilha:', error);
                alert(`Erro ao buscar dados da planilha: ${error.message}`);
            });
    </script>
    
    
</body>
</html>
